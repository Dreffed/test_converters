{% extends 'base.html' %}
{% block content %}
<section>
  <h2>Upload PDFs</h2>
  <form action="/api/files" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept="application/pdf" required />
    <button class="btn" type="submit">Upload</button>
  </form>
  <p>Uploaded files ({{ uploads|length }}):</p>
  <ul>
    {% for f in uploads %}
      <li>{{ f.name }} ({{ f.size }} bytes)</li>
    {% endfor %}
  </ul>
</section>

<section>
  <h2>Recent Runs</h2>
  <div class="table-responsive">
  <table id="runsTable">
    <thead>
      <tr><th>ID</th><th>Created</th><th>Status</th><th>Files</th><th>Converters</th><th>Actions</th></tr>
    </thead>
    <tbody>
      {% for r in runs %}
        <tr data-run-id="{{ r.id }}" data-run-status="{{ r.status }}">
          <td>{{ r.id }}</td>
          <td>{{ r.created_at }}</td>
          <td class="status {{ r.status }}"><span class="status-text">{{ r.status }}</span></td>
          <td>{{ r.files|length }}</td>
          <td>{{ r.converters|length }}</td>
          <td>
            <a class="btn" href="/runs/{{ r.id }}">Details</a>
            <a class="btn" href="/runs/{{ r.id }}/view">Viewer</a>
            <a class="btn" href="/runs/{{ r.id }}/tables">Tables</a>
            <button class="btn btn-danger delete-run" data-run-id="{{ r.id }}">Delete</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
</section>
<script>
  document.querySelectorAll('.delete-run').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      const id = btn.getAttribute('data-run-id');
      if (!id) return;
      if (!confirm(`Delete run #${id}? This will remove its results.`)) return;
      try {
        const resp = await fetch(`/api/runs/${id}`, { method: 'DELETE' });
        if (resp.ok) { location.reload(); } else { alert('Failed to delete run'); }
      } catch { alert('Error deleting run'); }
    });
  });
  // Poll for run status updates
  async function pollRuns(){
    try{
      const resp = await fetch('/api/runs');
      if(!resp.ok) return;
      const data = await resp.json();
      const runs = data.runs || [];
      const map = new Map(runs.map(r => [String(r.id), r]));
      document.querySelectorAll('#runsTable tbody tr').forEach(tr => {
        const id = tr.getAttribute('data-run-id');
        const cur = map.get(id);
        if(!cur) return;
        const prev = tr.getAttribute('data-run-status');
        if (prev !== cur.status){
          tr.setAttribute('data-run-status', cur.status);
          const td = tr.querySelector('.status');
          if (td){ td.className = 'status ' + cur.status; const span = td.querySelector('.status-text'); if (span) span.textContent = cur.status; }
        }
      });
    } catch {}
  }
  setInterval(pollRuns, 3000);
  </script>
{% endblock %}
