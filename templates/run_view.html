{% extends 'base.html' %}
{% block content %}
<h2>Run #{{ run.id }} â€” Composite Viewer</h2>
{% if run.status != 'done' %}
<div class="banner" id="runBanner">Run status: <strong id="runStatus">{{ run.status }}</strong>. The page will refresh when complete.</div>
{% endif %}
<p>
  <button class="btn btn-danger" id="deleteRunBtn" data-run-id="{{ run.id }}">Delete Run</button>
  <a class="btn" href="/">Back</a>
  <a class="btn" href="/runs/{{ run.id }}">Details</a>
</p>

<link rel="stylesheet" href="/static/css/viewer.css" />

<div class="viewer-layout">
  <aside class="viewer-side">
    <div class="group">
      <label for="docSelect">Document</label>
      <select id="docSelect" aria-label="Document"></select>
      <div id="pageLimitWarn" class="warn" hidden>Showing first 10 pages. <button id="overrideLimit">Show all</button></div>
    </div>
    <div class="group">
      <div class="row"><input id="toggleGray" type="checkbox"/> <label for="toggleGray">Grayscale</label></div>
      <div class="row"><input id="toggleGrayServer" type="checkbox"/> <label for="toggleGrayServer">Use server grayscale</label></div>
      <div class="row"><input id="toggleNums" type="checkbox"/> <label for="toggleNums">Show BBox Numbers</label></div>
      <label>Overlay Opacity <input id="opacity" type="range" min="0" max="100" value="70"/></label>
    </div>
    <div class="group">
      <label>Parsers</label>
      <div id="parsers"></div>
      <div id="legend" class="legend"></div>
    </div>
    <div class="group">
      <label for="mergeMode">Merge</label>
      <select id="mergeMode" aria-label="Merge mode">
        <option value="vertical">Vertical</option>
        <option value="horizontal">Horizontal</option>
        <option value="paragraph">Paragraph</option>
      </select>
      <div class="row">
        <button id="applyMerge">Apply Merge</button>
      </div>
    </div>
    <div class="group">
      <label>Overlay Types</label>
      <div class="row"><input id="toggleTextBoxes" type="checkbox" checked/> <label for="toggleTextBoxes">Text BBoxes</label></div>
      <div class="row"><input id="toggleMerged" type="checkbox"/> <label for="toggleMerged">Merged BBoxes</label></div>
      <div class="row"><input id="toggleTableBoxes" type="checkbox"/> <label for="toggleTableBoxes">Table BBoxes</label></div>
      </div>
    <div class="group">
      <label for="consTool">Consolidation Tool</label>
      <select id="consTool"></select>
      <div class="row">
        <button id="runCons">Run Consolidation</button>
      </div>
      <div class="row"><input id="showConsRedundant" type="checkbox"/> <label for="showConsRedundant">Show Redundant</label></div>
      <div class="row"><input id="showConsUnique" type="checkbox"/> <label for="showConsUnique">Show Unique-Extra</label></div>
      <div class="row"><input id="showConsGroups" type="checkbox"/> <label for="showConsGroups">Show Groups</label></div>
    </div>
    </div>
    <div class="group">
      <button id="exportBtn">Export Package</button>
    </div>
  </aside>
  <main class="viewer-main">
    <div class="toolbar">
      <button id="prevBtn">Prev</button>
      <span>
        <label for="pageInput">Page</label>
        <input id="pageInput" type="number" min="0" value="0" aria-label="Page index"/>
        / <span id="pageTotal">0</span>
      </span>
      <button id="nextBtn">Next</button>
      <span class="spacer"></span>
      <button id="zoomOut">-</button>
      <button id="zoomReset">100%</button>
      <button id="zoomIn">+</button>
      <span class="spacer"></span>
      <button id="clearSel">Clear Selection</button>
    </div>
    <div id="viewport" class="viewport">
      <div id="canvas" class="canvas">
        <img id="pageImg" alt="page" />
        <svg id="overlay" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
    </div>
    <section class="bottom-panel">
      <div class="bottom-grid">
        <div class="text-col">
          <div class="tabs" id="resultTabs"></div>
          <div class="tab-panels" id="resultPanels"></div>
        </div>
        <div class="tables-col">
          <h4>Tables (current page)</h4>
          <div id="tablesTabs" class="tabs"></div>
          <div id="tablesPanels" class="tab-panels"></div>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  window.__RUN_ID__ = {{ run.id }};
  window.__VISUAL_INDEX__ = {{ visual_index_json | safe }};
</script>
<script src="/static/js/run_view.js"></script>
<script>
  (function(){
    const delBtn = document.getElementById('deleteRunBtn');
    if (delBtn) {
      delBtn.addEventListener('click', async () => {
        const id = delBtn.getAttribute('data-run-id');
        if (!id) return;
        if (!confirm(`Delete run #${id}? This will remove its results.`)) return;
        try { const resp = await fetch(`/api/runs/${id}`, { method: 'DELETE' });
          if (resp.ok) { window.location.href = '/'; } else { alert('Failed to delete run'); }
        } catch { alert('Error deleting run'); }
      });
    }
  })();
  // Poll status to refresh when done
  (function(){
    const runId = {{ run.id }};
    const banner = document.getElementById('runBanner');
    const statusEl = document.getElementById('runStatus');
    let last = '{{ run.status }}';
    async function poll(){
      try{
        const r = await fetch(`/api/runs/${runId}`);
        if(!r.ok) return; const data = await r.json();
        if (data.status && data.status !== last){
          last = data.status;
          if (statusEl) statusEl.textContent = data.status;
          if (data.status === 'done' || data.status === 'failed') { location.reload(); }
        }
      } catch {}
    }
    setInterval(poll, 3000);
  })();
</script>
{% endblock %}
