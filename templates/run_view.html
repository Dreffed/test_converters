{% extends 'base.html' %}
{% block content %}
<h2>Run #{{ run.id }} â€” Composite Viewer</h2>
<p>
  <button class="btn btn-danger" id="deleteRunBtn" data-run-id="{{ run.id }}">Delete Run</button>
  <a class="btn" href="/">Back</a>
  <a class="btn" href="/runs/{{ run.id }}">Details</a>
</p>

<link rel="stylesheet" href="/static/css/viewer.css" />

<div class="viewer-layout">
  <aside class="viewer-side">
    <div class="group">
      <label for="docSelect">Document</label>
      <select id="docSelect" aria-label="Document"></select>
      <div id="pageLimitWarn" class="warn" hidden>Showing first 10 pages. <button id="overrideLimit">Show all</button></div>
    </div>
    <div class="group">
      <div class="row"><input id="toggleGray" type="checkbox"/> <label for="toggleGray">Grayscale</label></div>
      <div class="row"><input id="toggleGrayServer" type="checkbox"/> <label for="toggleGrayServer">Use server grayscale</label></div>
      <div class="row"><input id="toggleNums" type="checkbox"/> <label for="toggleNums">Show BBox Numbers</label></div>
      <label>Overlay Opacity <input id="opacity" type="range" min="0" max="100" value="70"/></label>
    </div>
    <div class="group">
      <label>Parsers</label>
      <div id="parsers"></div>
      <div id="legend" class="legend"></div>
    </div>
    <div class="group">
      <label for="mergeMode">Merge</label>
      <select id="mergeMode" aria-label="Merge mode">
        <option value="vertical">Vertical</option>
        <option value="horizontal">Horizontal</option>
        <option value="paragraph">Paragraph</option>
      </select>
      <div class="row">
        <button id="applyMerge">Apply Merge</button>
      </div>
    </div>
    <div class="group">
      <label>Overlay Types</label>
      <div class="row"><input id="toggleTextBoxes" type="checkbox" checked/> <label for="toggleTextBoxes">Text BBoxes</label></div>
      <div class="row"><input id="toggleMerged" type="checkbox"/> <label for="toggleMerged">Merged BBoxes</label></div>
      <div class="row"><input id="toggleTableBoxes" type="checkbox"/> <label for="toggleTableBoxes">Table BBoxes</label></div>
      </div>
    </div>
    <div class="group">
      <button id="exportBtn">Export Package</button>
    </div>
  </aside>
  <main class="viewer-main">
    <div class="toolbar">
      <button id="prevBtn">Prev</button>
      <span>
        <label for="pageInput">Page</label>
        <input id="pageInput" type="number" min="0" value="0" aria-label="Page index"/>
        / <span id="pageTotal">0</span>
      </span>
      <button id="nextBtn">Next</button>
      <span class="spacer"></span>
      <button id="zoomOut">-</button>
      <button id="zoomReset">100%</button>
      <button id="zoomIn">+</button>
      <span class="spacer"></span>
      <button id="clearSel">Clear Selection</button>
    </div>
    <div id="viewport" class="viewport">
      <div id="canvas" class="canvas">
        <img id="pageImg" alt="page" />
        <svg id="overlay" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
    </div>
    <section class="bottom-panel">
      <div class="tabs" id="resultTabs"></div>
      <div class="tab-panels" id="resultPanels"></div>
      <hr/>
      <div>
        <h4>Tables (current page)</h4>
        <div id="tablesTabs" class="tabs"></div>
        <div id="tablesPanels" class="tab-panels"></div>
      </div>
    </section>
  </main>
</div>

<script>
  window.__RUN_ID__ = {{ run.id }};
  window.__VISUAL_INDEX__ = {{ visual_index_json | safe }};
</script>
<script src="/static/js/run_view.js"></script>
<script>
  (function(){
    const delBtn = document.getElementById('deleteRunBtn');
    if (delBtn) {
      delBtn.addEventListener('click', async () => {
        const id = delBtn.getAttribute('data-run-id');
        if (!id) return;
        if (!confirm(`Delete run #${id}? This will remove its results.`)) return;
        try { const resp = await fetch(`/api/runs/${id}`, { method: 'DELETE' });
          if (resp.ok) { window.location.href = '/'; } else { alert('Failed to delete run'); }
        } catch { alert('Error deleting run'); }
      });
    }
  })();
</script>
{% endblock %}
