{% extends 'base.html' %}
{% block content %}
<h2>Run #{{ run.id }} - Tables</h2>
{% if run.status != 'done' %}
<div class="banner" id="runBanner">Run status: <strong id="runStatus">{{ run.status }}</strong>. The page will refresh when complete.</div>
{% endif %}
<p>
  <button class="btn btn-danger" id="deleteRunBtn" data-run-id="{{ run.id }}">Delete Run</button>
  <a class="btn" href="/">Back</a>
  <a class="btn" href="/runs/{{ run.id }}">Details</a>
</p>

{% if converters %}
  <div>
    <label for="docSelect">Document:
      <select id="docSelect"></select>
    </label>
    <label for="convSelect">Converter:
      <select id="convSelect">
        {% for c in converters %}
          <option value="{{ c }}">{{ c }}</option>
        {% endfor %}
      </select>
    </label>
    <label for="pageSelect">Page:
      <select id="pageSelect"></select>
    </label>
  </div>

  <div class="table-responsive"><div id="tablesContainer" style="margin-top:1rem;"></div></div>

  <script>
    const tablesData = {{ tables_json | safe }}; // data[doc][converter][page] = tables
    const pagesByDoc = {{ pages_by_doc_json | safe }}; // { doc: [pages] }
    const docs = {{ docs_json | safe }};
    const convSelect = document.getElementById('convSelect');
    const docSelect = document.getElementById('docSelect');
    const pageSelect = document.getElementById('pageSelect');
    const container = document.getElementById('tablesContainer');

    function populateDocs() {
      docSelect.innerHTML = '';
      (docs || []).forEach(d => {
        const opt = document.createElement('option');
        opt.value = d; opt.textContent = d; docSelect.appendChild(opt);
      });
    }

    function populatePages() {
      const doc = docSelect.value;
      const pages = pagesByDoc[doc] || [];
      pageSelect.innerHTML = '';
      pages.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p; opt.textContent = p; pageSelect.appendChild(opt);
      });
    }

    function renderTables() {
      const conv = convSelect.value;
      const doc = docSelect.value;
      const page = pageSelect.value;
      container.innerHTML = '';
      const pageTables = (((tablesData[doc]||{})[conv]) || {})[String(page)] || [];
      if (pageTables.length === 0) {
        container.innerHTML = '<p>No tables found for this page.</p>';
        return;
      }
      pageTables.forEach((t, idx) => {
        const tbl = document.createElement('table');
        tbl.style.borderCollapse = 'collapse';
        tbl.style.marginBottom = '1rem';
        const caption = document.createElement('caption');
        caption.textContent = 'Table #' + (idx+1);
        caption.style.textAlign = 'left';
        tbl.appendChild(caption);
        (t.rows || []).forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            td.style.border = '1px solid #ccc';
            td.style.padding = '4px 6px';
            tr.appendChild(td);
          });
          tbl.appendChild(tr);
        });
        container.appendChild(tbl);
      });
    }

    convSelect.addEventListener('change', renderTables);
    docSelect.addEventListener('change', () => { populatePages(); renderTables(); });
    pageSelect.addEventListener('change', renderTables);
    populateDocs();
    if (docs && docs.length) { docSelect.value = docs[0]; }
    populatePages();
    renderTables();
  </script>
  <script>
    // Poll status
    (function(){
      const runId = {{ run.id }};
      const banner = document.getElementById('runBanner');
      const statusEl = document.getElementById('runStatus');
      let last = '{{ run.status }}';
      async function poll(){
        try{
          const r = await fetch(`/api/runs/${runId}`);
          if(!r.ok) return; const data = await r.json();
          if (data.status && data.status !== last){
            last = data.status;
            if (statusEl) statusEl.textContent = data.status;
            if (data.status === 'done' || data.status === 'failed') { location.reload(); }
          }
        } catch {}
      }
      setInterval(poll, 3000);
    })();
  </script>
  <script>
    (function(){
      const delBtn = document.getElementById('deleteRunBtn');
      if (delBtn) {
        delBtn.addEventListener('click', async () => {
          const id = delBtn.getAttribute('data-run-id');
          if (!id) return;
          if (!confirm(`Delete run #${id}? This will remove its results.`)) return;
          try { const resp = await fetch(`/api/runs/${id}`, { method: 'DELETE' });
            if (resp.ok) { window.location.href = '/'; } else { alert('Failed to delete run'); }
          } catch { alert('Error deleting run'); }
        });
      }
    })();
  </script>
{% else %}
  <p>No tables were extracted for this run. Ensure table extraction is enabled and a supported engine like <code>pdfplumber</code> is used.</p>
{% endif %}

<p><a class="btn" href="/runs/{{ run.id }}">Back</a></p>
{% endblock %}
