{% extends 'base.html' %}
{% block content %}
<h2>Run #{{ run.id }}</h2>
<p>Status: <strong id="runStatus">{{ run.status }}</strong></p>
<p>Created: {{ run.created_at }}</p>
<p>
  <button class="btn btn-danger" id="deleteRunBtn" data-run-id="{{ run.id }}">Delete Run</button>
  <a class="btn" href="/">Back</a>
</p>
<h3>Inputs</h3>
<ul>
  <li>Files: <code>{{ run.files|join(', ') }}</code></li>
  <li>Converters: <code>{{ run.converters|join(', ') }}</code></li>
  <li>Baseline: <code>{{ run.baseline }}</code></li>
  <li>Visualize: <code>{{ run.visualize }}</code></li>
</ul>

{% if run.artifacts %}
<h3>Artifacts</h3>
<ul>
  {% if run.artifacts.summary %}<li>Summary: <a href="/api/artifacts?path={{ run.artifacts.summary }}">summary.md</a></li>{% endif %}
  {% if run.artifacts.report %}<li>Report: <a href="/api/artifacts?path={{ run.artifacts.report }}">benchmark_report.json</a></li>{% endif %}
  {% if run.artifacts.details %}<li>Details: <a href="/api/artifacts?path={{ run.artifacts.details }}">detailed_results.json</a></li>{% endif %}
  {% if run.artifacts.visual_dir %}<li>Visual dir: <code>{{ run.artifacts.visual_dir }}</code></li>{% endif %}
  {% if run.error %}<li>Error: <code>{{ run.error }}</code></li>{% endif %}
  </ul>

  {% if run.artifacts.report %}
  <h3>Converter Performance</h3>
  <div id="perfCharts" data-report="{{ run.artifacts.report }}" style="max-width: 960px;">
    <div id="timeChart"></div>
    <div id="successChart" style="margin-top: 12px;"></div>
  </div>
  <script>
    (async function(){
      const el = document.getElementById('perfCharts'); if(!el) return;
      const path = el.getAttribute('data-report');
      try{
        const resp = await fetch('/api/artifacts?path=' + encodeURIComponent(path));
        if(!resp.ok) return; const data = await resp.json();
        const convs = data.converters || {};
        const items = Object.entries(convs).map(([name, s])=>({ name, avg_time: s.avg_time||0, success_rate: (s.successes||0)/(s.total_tests||1) }));
        items.sort((a,b)=> b.avg_time - a.avg_time);
        // render bars
        const maxTime = Math.max(1, ...items.map(i=>i.avg_time));
        function barRow(i, key, max, unit){
          const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.margin='4px 0';
          const label = document.createElement('div'); label.textContent=i.name; label.style.width='160px';
          const bar = document.createElement('div'); bar.style.height='14px'; bar.style.background='#e8e8e8'; bar.style.flex='1'; bar.style.margin='0 8px'; bar.style.position='relative';
          const fill = document.createElement('div'); fill.style.height='100%'; fill.style.width=((i[key]/max)*100).toFixed(1)+'%'; fill.style.background= key==='avg_time'? '#4a90e2':'#6cbf6c'; bar.appendChild(fill);
          const val = document.createElement('div'); val.textContent = key==='avg_time' ? i[key].toFixed(3)+' s' : Math.round(i[key]*100)+'%'; val.style.width='80px'; val.style.textAlign='right';
          wrap.appendChild(label); wrap.appendChild(bar); wrap.appendChild(val); return wrap;
        }
        const timeChart = document.getElementById('timeChart');
        const succChart = document.getElementById('successChart');
        const h1 = document.createElement('h4'); h1.textContent='Average Time (s)'; timeChart.appendChild(h1);
        items.forEach(i=> timeChart.appendChild(barRow(i,'avg_time', maxTime, 's')));
        const h2 = document.createElement('h4'); h2.textContent='Success Rate'; succChart.appendChild(h2);
        items.slice().sort((a,b)=> b.success_rate - a.success_rate).forEach(i=> succChart.appendChild(barRow(i,'success_rate', 1.0, '%')));
      } catch(e){}
    })();
  </script>
  {% endif %}

  {% if summary_html %}
  <h3>Summary (Markdown)</h3>
  <div class="md" id="summaryMd">{{ summary_html | safe }}</div>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    // Transform fenced ```mermaid code blocks into <div class="mermaid"> for rendering
    (function(){
      const root = document.getElementById('summaryMd');
      if (!root) return;
      const blocks = root.querySelectorAll('pre > code');
      blocks.forEach(code => {
        const cls = code.className || '';
        if (/(^|\s)language-mermaid(\s|$)|(\s)mermaid(\s|$)/.test(cls)){
          const pre = code.parentElement;
          const div = document.createElement('div');
          div.className = 'mermaid';
          div.textContent = code.textContent || '';
          pre.replaceWith(div);
        }
      });
      if (window.mermaid){
        try { window.mermaid.initialize({ startOnLoad: true }); } catch(e){}
      }
    })();
  </script>
  {% endif %}

  <h3>JSON Viewer</h3>
  <div>
    <label for="jsonSelect">Select JSON</label>
    <select id="jsonSelect">
      {% if run.artifacts.report %}<option value="{{ run.artifacts.report }}">Benchmark Report</option>{% endif %}
      {% if run.artifacts.details %}<option value="{{ run.artifacts.details }}">Detailed Results</option>{% endif %}
    </select>
    <button id="refreshAnalysisBtn" class="btn">Update Consolidation & Merge</button>
  </div>
  <div id="jsonTree" style="border:1px solid #ddd; border-radius:6px; padding:8px; max-height: 420px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; font-size: 13px;"></div>
  <script>
    function renderNode(key, value){
      if (value && typeof value === 'object'){
        const det = document.createElement('details');
        const sum = document.createElement('summary'); sum.textContent = key + (Array.isArray(value)? ' [ ]' : ' { }');
        det.appendChild(sum);
        if (Array.isArray(value)){
          value.forEach((v, i)=> det.appendChild(renderNode(String(i), v)));
        } else {
          Object.keys(value).forEach(k=> det.appendChild(renderNode(k, value[k])));
        }
        return det;
      } else {
        const div = document.createElement('div');
        const span = document.createElement('span'); span.textContent = key + ': ';
        const code = document.createElement('code'); code.textContent = (value===null? 'null' : String(value));
        div.appendChild(span); div.appendChild(code);
        return div;
      }
    }
    async function loadJson(path){
      const tree = document.getElementById('jsonTree'); tree.innerHTML = 'Loading...';
      try{
        const resp = await fetch('/api/artifacts?path=' + encodeURIComponent(path));
        if(!resp.ok){ tree.textContent='Failed to load JSON'; return; }
        const data = await resp.json();
        tree.innerHTML='';
        const root = renderNode('root', data); root.setAttribute('open',''); tree.appendChild(root);
      } catch(e){ tree.textContent='Error loading JSON'; }
    }
    (function(){ const sel=document.getElementById('jsonSelect'); if(sel){ sel.addEventListener('change', ()=> loadJson(sel.value)); if (sel.value) loadJson(sel.value); } })();
    (function(){
      const btn = document.getElementById('refreshAnalysisBtn');
      if (!btn) return;
      btn.addEventListener('click', async ()=>{
        btn.disabled = true; btn.textContent = 'Updating...';
        try{
          const resp = await fetch(`/api/runs/{{ run.id }}/enrich_details`, { method:'POST' });
          if (resp.ok){ alert('Consolidation & merge data updated in detailed results.'); } else { alert('Update failed'); }
        } catch { alert('Error updating'); }
        finally { btn.disabled = false; btn.textContent = 'Update Consolidation & Merge'; }
      });
    })();
  </script>

<p>
  <a class="btn" href="/runs/{{ run.id }}/view">Open Viewer</a>
  <a class="btn" href="/runs/{{ run.id }}/tables">Tables</a>
</p>
{% endif %}

<script>
  const delBtn = document.getElementById('deleteRunBtn');
  if (delBtn) {
    delBtn.addEventListener('click', async () => {
      const id = delBtn.getAttribute('data-run-id');
      if (!id) return;
      if (!confirm(`Delete run #${id}? This will remove its results.`)) return;
      try {
        const resp = await fetch(`/api/runs/${id}`, { method: 'DELETE' });
        if (resp.ok) { window.location.href = '/'; } else { alert('Failed to delete run'); }
      } catch { alert('Error deleting run'); }
    });
  }
  // Poll status
  const statusEl = document.getElementById('runStatus');
  const runId = {{ run.id }};
  let lastStatus = '{{ run.status }}';
  async function poll(){
    try{
      const resp = await fetch(`/api/runs/${runId}`);
      if (!resp.ok) return;
      const data = await resp.json();
      if (data.status && data.status !== lastStatus){
        lastStatus = data.status;
        if (statusEl) statusEl.textContent = data.status;
        if (data.status === 'done' || data.status === 'failed') { location.reload(); }
      }
    } catch {}
  }
  setInterval(poll, 3000);
</script>
{% endblock %}
