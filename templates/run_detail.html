{% extends 'base.html' %}
{% block content %}
<h2>Run #{{ run.id }}</h2>
<p>Status: <strong id="runStatus">{{ run.status }}</strong></p>
<p>Created: {{ run.created_at }}</p>
<p>
  <button class="btn btn-danger" id="deleteRunBtn" data-run-id="{{ run.id }}">Delete Run</button>
  <a class="btn" href="/">Back</a>
</p>
<h3>Inputs</h3>
<ul>
  <li>Files: <code>{{ run.files|join(', ') }}</code></li>
  <li>Converters: <code>{{ run.converters|join(', ') }}</code></li>
  <li>Baseline: <code>{{ run.baseline }}</code></li>
  <li>Visualize: <code>{{ run.visualize }}</code></li>
</ul>

{% if run.artifacts %}
<h3>Artifacts</h3>
<ul>
  {% if run.artifacts.summary %}<li>Summary: <a href="/api/artifacts?path={{ run.artifacts.summary }}">summary.md</a></li>{% endif %}
  {% if run.artifacts.report %}<li>Report: <a href="/api/artifacts?path={{ run.artifacts.report }}">benchmark_report.json</a></li>{% endif %}
  {% if run.artifacts.details %}<li>Details: <a href="/api/artifacts?path={{ run.artifacts.details }}">detailed_results.json</a></li>{% endif %}
  {% if run.artifacts.visual_dir %}<li>Visual dir: <code>{{ run.artifacts.visual_dir }}</code></li>{% endif %}
  {% if run.error %}<li>Error: <code>{{ run.error }}</code></li>{% endif %}
  </ul>

<p>
  <a class="btn" href="/runs/{{ run.id }}/view">Open Viewer</a>
  <a class="btn" href="/runs/{{ run.id }}/tables">Tables</a>
</p>
{% endif %}

<script>
  const delBtn = document.getElementById('deleteRunBtn');
  if (delBtn) {
    delBtn.addEventListener('click', async () => {
      const id = delBtn.getAttribute('data-run-id');
      if (!id) return;
      if (!confirm(`Delete run #${id}? This will remove its results.`)) return;
      try {
        const resp = await fetch(`/api/runs/${id}`, { method: 'DELETE' });
        if (resp.ok) { window.location.href = '/'; } else { alert('Failed to delete run'); }
      } catch { alert('Error deleting run'); }
    });
  }
  // Poll status
  const statusEl = document.getElementById('runStatus');
  const runId = {{ run.id }};
  let lastStatus = '{{ run.status }}';
  async function poll(){
    try{
      const resp = await fetch(`/api/runs/${runId}`);
      if (!resp.ok) return;
      const data = await resp.json();
      if (data.status && data.status !== lastStatus){
        lastStatus = data.status;
        if (statusEl) statusEl.textContent = data.status;
        if (data.status === 'done' || data.status === 'failed') { location.reload(); }
      }
    } catch {}
  }
  setInterval(poll, 3000);
</script>
{% endblock %}
